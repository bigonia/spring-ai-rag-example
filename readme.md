# **æ™ºèƒ½æ•°æ®åº“åˆ†æä¸RAGçŸ¥è¯†åº“ç³»ç»Ÿè®¾è®¡æ–‡æ¡£**

ç‰ˆæœ¬: 3.0  
æ—¥æœŸ: 2025å¹´1æœˆ25æ—¥  
ä½œè€…: AI Assistant

## **1\. å¼•è¨€**

### **1.1. é¡¹ç›®ç›®æ ‡**

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé›†æˆäº†**æ•°æ®åº“å…ƒæ•°æ®é‡‡é›†**ã€**æ™ºèƒ½åˆ†æ**å’Œ**RAGçŸ¥è¯†åº“**çš„ç»¼åˆæ€§ç³»ç»Ÿã€‚ç³»ç»Ÿçš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š

1. **æ•°æ®åº“æ™ºèƒ½åˆ†æ**: é€šè¿‡MetadataCollectorServiceè‡ªåŠ¨é‡‡é›†å„ç±»æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€SQL Serverç­‰ï¼‰çš„å®Œæ•´å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€åˆ—ä¿¡æ¯ã€æ•°æ®è´¨é‡æŒ‡æ ‡ç­‰
2. **çŸ¥è¯†åº“æ„å»º**: å°†é‡‡é›†åˆ°çš„æ•°æ®åº“å…ƒæ•°æ®è½¬æ¢ä¸ºç»“æ„åŒ–æ–‡æ¡£ï¼Œå¹¶åŸºäºRAGæŠ€æœ¯æ„å»ºæ™ºèƒ½çŸ¥è¯†åº“
3. **AIé—®ç­”æœåŠ¡**: æä¾›åŸºäºSpring AIçš„æ™ºèƒ½é—®ç­”èƒ½åŠ›ï¼Œæ”¯æŒçº¯èŠå¤©å’ŒRAGå¢å¼ºä¸¤ç§æ¨¡å¼
4. **ç»Ÿä¸€å¹³å°**: ä¸ºæ•°æ®åº“ç®¡ç†ã€æ•°æ®æ²»ç†å’ŒAIé©±åŠ¨çš„æ•°æ®åˆ†ææä¾›ç»Ÿä¸€çš„åŸºç¡€å¹³å°

### **1.2. è®¾è®¡åŸåˆ™**

* **æ¨¡å—åŒ– (Modularity):** æ•°æ®åº“åˆ†ææ¨¡å—ä¸AIæ¨¡å—å®Œå…¨è§£è€¦ï¼Œå„ç»„ä»¶èŒè´£å•ä¸€ã€è¾¹ç•Œæ¸…æ™°
* **å¤šæ•°æ®åº“æ”¯æŒ (Multi-Database):** é€šè¿‡DatabaseDialectæ¥å£æ”¯æŒMySQLã€PostgreSQLã€SQL Serverç­‰å¤šç§æ•°æ®åº“
* **å¯æ‰©å±•æ€§ (Extensibility):** æ”¯æŒæ–°çš„æ•°æ®åº“ç±»å‹ã€æ–°çš„æ–‡æ¡£æ ¼å¼å’Œæ–°çš„AIæ¨¡å‹
* **å¼‚æ­¥å¤„ç† (Asynchronous):** æ•°æ®åº“å…ƒæ•°æ®é‡‡é›†å’ŒAIå¤„ç†å‡æ”¯æŒå¼‚æ­¥æ‰§è¡Œï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
* **ç”Ÿäº§å°±ç»ª (Production-Ready):** å®Œå–„çš„è¶…æ—¶æ§åˆ¶ã€é”™è¯¯å¤„ç†å’Œç›‘æ§èƒ½åŠ›

### **1.3. æŠ€æœ¯é€‰å‹**

* **åç«¯æ¡†æ¶:** Spring Boot 3.5+
* **AI ç¼–æ’:** Spring AI 1.0+
* **æ•°æ®åº“:** PostgreSQL 15+ (ä¸»åº“) + MySQL/SQL Server (è¢«åˆ†æåº“)
* **å‘é‡æ”¯æŒ:** pgvector æ‰©å±•
* **æŒä¹…åŒ–:** Spring Data JPA + JDBC Template
* **å¼€å‘è¯­è¨€:** Java 17+
* **æ„å»ºå·¥å…·:** Maven
* **APIæ–‡æ¡£:** Swagger/OpenAPI 3.0

## **2\. ç³»ç»Ÿæ¶æ„**


```mermaid
flowchart TD
    Start[å¼€å§‹] --> A;
    subgraph "ä¸€ã€çŸ¥è¯†åº“æ„å»ºæµç¨‹"
        A(æ¥å…¥æ•°æ®æº) --> B{æ•°æ®é‡‡é›†ä¸åˆ†æ};
        B --> B1[è¡¨/åˆ—ä¿¡æ¯, é‡‡æ ·æ•°æ®];
        B --> B2[ç»Ÿè®¡æ•°æ®: åŸºæ•°, ç©ºå€¼ç‡ç­‰];
        B1 --> C(AIæ•°æ®ä¸°å¯Œ - æ¨æ–­ä¸šåŠ¡å±æ€§);
        B2 --> C;
        C --> D[ç”Ÿæˆå…ƒæ•°æ® JSON];
        D --> E(æŒä¹…åŒ–JSON);
        E --> F(åŸºäºJSONç”Ÿæˆæ•°æ®æŠ¥å‘Š - MDæ ¼å¼);
        E --> G(å‘é‡åŒ–å¹¶å†™å…¥å‘é‡åº“);
    end
    
    subgraph "äºŒã€AIåˆ†æä½¿ç”¨æµç¨‹"
        H(ç”¨æˆ·æé—®) --> I{æŸ¥è¯¢å‘é‡åº“};
        I --> J{è¡¥å……ä¸Šä¸‹æ–‡?};
        J -- æ˜¯ --> K[æŸ¥è¯¢å…ƒæ•°æ®/æ ·ä¾‹æ•°æ®];
        K --> L(ç”Ÿæˆå›ç­”);
        J -- å¦ --> L;
    end
    
    G --> H[çŸ¥è¯†åº“æ„å»ºå®Œæˆï¼Œå¯ç”¨AIåˆ†ææµç¨‹]; 
    L --> End[ç»“æŸ];

```

æˆ‘ä¹‹å‰çš„å»ºè®®ï¼ˆâ€œå¦‚æœåªå¬å›ä¸€å¼ è¡¨ï¼Œå°±ä¸è¡¥å……æ±‡æ€»æŠ¥å‘Šâ€ï¼‰ç¡®å®è¿‡äºç†æƒ³åŒ–äº†ã€‚æ‚¨æ‹…å¿ƒçš„â€œå³ä½¿è¡¨é¢é—®ä¸€å¼ è¡¨ï¼ŒLLMä¹Ÿå¯èƒ½éœ€è¦å…¨å±€è§†é‡â€æ˜¯å®Œå…¨å¯èƒ½å‘ç”Ÿçš„ï¼Œè¿™æ­£æ˜¯RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ä¸­çš„ä¸€ä¸ªç»å…¸éš¾é¢˜ï¼šâ€œå±€éƒ¨æœ€ä¼˜ï¼ˆå¬å›äº†æœ€ç›¸å…³çš„å—ï¼‰ä¸ç­‰äºå…¨å±€æœ€ä¼˜ï¼ˆå›ç­”é—®é¢˜æ‰€éœ€çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼‰â€ã€‚

ä¸ºä»€ä¹ˆâ€œToolâ€æ–¹æ¡ˆä¹Ÿä¸ç†æƒ³ï¼Ÿ
æ¥ç€ï¼Œæ‚¨è‡ªå·±æå‡ºçš„â€œå°†æ±‡æ€»æŠ¥å‘Šä½œä¸ºToolâ€çš„æƒ³æ³•ï¼Œä»¥åŠæ‚¨è‡ªå·±å¯¹å®ƒçš„æ‹…å¿§ï¼ˆä¸Šä¸‹æ–‡ä¸å¯æ§ã€LLMæ¯æ¬¡éƒ½è°ƒç”¨ï¼‰â€”â€” æ‚¨çš„æ‹…å¿§æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚

å»¶è¿Ÿä¸æˆæœ¬ï¼š è¿™ä¼šæŠŠä¸€æ¬¡LLMè°ƒç”¨å˜æˆä¸¤æ¬¡ï¼ˆä¸€æ¬¡ä¸»è°ƒç”¨ï¼Œä¸€æ¬¡å·¥å…·è°ƒç”¨ï¼‰ï¼Œå»¶è¿Ÿç¿»å€ï¼Œæˆæœ¬å¢åŠ ã€‚

ä¸å¯æ§æ€§ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰ï¼š æ‚¨æŠŠâ€œæ˜¯å¦éœ€è¦å…¨å±€è§†é‡â€è¿™ä¸ªå…³é”®çš„æ¶æ„å†³ç­–äº¤ç»™äº†LLMã€‚è€ŒLLMä¸ºäº†â€œå®‰å…¨å›ç­”â€ï¼Œå¤§æ¦‚ç‡ä¼šæ¯æ¬¡éƒ½å»è°ƒç”¨è¿™ä¸ªå·¥å…·ï¼Œè¿™åœ¨æ•ˆæœä¸Šç­‰åŒäºæ‚¨ç°åœ¨â€œæ¯æ¬¡éƒ½å¼ºåˆ¶è¡¥å……â€çš„ç­–ç•¥ï¼Œä½†å¹³ç™½å¢åŠ äº†å»¶è¿Ÿå’Œå¤æ‚æ€§ã€‚

è§£å†³æ–¹æ¡ˆï¼šä¸€ä¸ªæ›´æ™ºèƒ½ã€å¯æ§çš„â€œä¸­é—´è·¯çº¿â€
æˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”±æ‚¨çš„åº”ç”¨ç¨‹åºï¼ˆApplicationï¼‰è€ŒéLLMæ¥æ§åˆ¶çš„ç­–ç•¥ã€‚è¿™ä¸ªç­–ç•¥å¿…é¡»æ¯”â€œæ€»æ˜¯è¡¥å……â€æ›´æ™ºèƒ½ï¼Œæ¯”â€œå®Œå…¨ä¸è¡¥å……â€æ›´å®‰å…¨ã€‚

è¿™ä¸ªç­–ç•¥å°±æ˜¯ï¼šåŸºäºâ€œæŸ¥è¯¢æ„å›¾â€çš„åŠ¨æ€ä¸Šä¸‹æ–‡è·¯ç”±ã€‚

æˆ‘ä»¬ä¸å†åªä¾èµ–RAGçš„å¬å›ç»“æœï¼Œè€Œæ˜¯å¢åŠ ä¸€ä¸ªâ€œå‰ç½®æ­¥éª¤â€ï¼šå¿«é€Ÿåˆ¤æ–­ç”¨æˆ·é—®é¢˜çš„â€œæ„å›¾â€ã€‚

æ‚¨å¯ä»¥å°†ç”¨æˆ·é—®é¢˜åˆ†ä¸ºä¸¤å¤§ç±»ï¼š

â€œäº‹å®å‹æŸ¥è¯¢â€ï¼ˆFact-Findingï¼‰ï¼š

ç‰¹ç‚¹ï¼šéå¸¸å…·ä½“ï¼Œé€šå¸¸é’ˆå¯¹æŸä¸ªè¡¨çš„æŸä¸ªç‰¹å®šæŒ‡æ ‡ã€‚

å…³é”®è¯ï¼šâ€œ...çš„ç©ºå€¼ç‡æ˜¯å¤šå°‘ï¼Ÿâ€ã€â€œ...æœ‰å¤šå°‘è¡Œï¼Ÿâ€ã€â€œ...çš„æ•°æ®ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿâ€ã€â€œ...çš„åŸºæ•°æ˜¯ï¼Ÿâ€

æ‰€éœ€ä¸Šä¸‹æ–‡ï¼š åªéœ€è¦â€œè¯¦ç»†æŠ¥å‘Šâ€ï¼Œä¸éœ€è¦â€œæ±‡æ€»æŠ¥å‘Šâ€ã€‚

â€œæ¢ç´¢å‹æŸ¥è¯¢â€ï¼ˆExploratoryï¼‰ï¼š

ç‰¹ç‚¹ï¼šæ¯”è¾ƒæ¨¡ç³Šã€å®è§‚ï¼Œå¯»æ±‚å…³ç³»æˆ–æ¦‚è§ˆã€‚

å…³é”®è¯ï¼šâ€œç»™æˆ‘ä»‹ç»ä¸€ä¸‹...â€ã€â€œ...å’Œ...æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿâ€ã€â€œ...çš„æ•°æ®æ€ä¹ˆæ ·ï¼Ÿâ€ã€â€œä¸ºä»€ä¹ˆ...ï¼Ÿâ€

æ‰€éœ€ä¸Šä¸‹æ–‡ï¼š å¿…é¡»åŒæ—¶æä¾›â€œè¯¦ç»†æŠ¥å‘Šâ€å’Œâ€œæ±‡æ€»æŠ¥å‘Šâ€ã€‚

------------------------

å»ºè®®äºŒï¼šã€æ„å»ºç¯èŠ‚ã€‘æ·±åŒ–AIæ²»ç†èƒ½åŠ›ï¼ˆä»â€œè¢«åŠ¨â€åˆ°â€œä¸»åŠ¨â€ï¼‰
è¿™æ˜¯å¯¹æˆ‘ä¹‹å‰å»ºè®®çš„é‡ç”³å’Œå¼ºè°ƒã€‚æ‚¨å½“å‰çš„AIï¼ˆæ­¥éª¤3ï¼‰æ˜¯â€œè¢«åŠ¨â€çš„ï¼Œå®ƒâ€œæ¨æ–­ä¸šåŠ¡å±æ€§â€ã€‚æˆ‘ä»¬å¯ä»¥è®©å®ƒå˜å¾—â€œä¸»åŠ¨â€ï¼Œå»è¯„ä¼°å’Œå»ºè®®ã€‚

1. è‡ªåŠ¨åŒ–çš„æ•æ„Ÿæ•°æ®ï¼ˆPIIï¼‰ä¸è¯­ä¹‰ç±»å‹è¯†åˆ«ï¼š

ç°çŠ¶ï¼š AIå¯èƒ½æ¨æ–­å‡ºâ€œä¸šåŠ¡å±æ€§ï¼šå®¢æˆ·è”ç³»æ–¹å¼â€ã€‚

ä¼˜åŒ–ï¼š AIåº”æ˜ç¡®è¯†åˆ« Semantic-Type: Email æˆ– PII-Level: High (èº«ä»½è¯å·)ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼Œè¿™æ˜¯æ•°æ®å®‰å…¨å’Œåˆè§„çš„åŸºçŸ³ã€‚åœ¨MDæŠ¥å‘Šå’Œå…ƒæ•°æ®ä¸­éƒ½åº”åŒ…å«è¿™ä¸ªå­—æ®µã€‚

ä»·å€¼ï¼š ä½¿æ‚¨çš„å¹³å°å…·å¤‡æ•°æ®å®‰å…¨å’Œéšç§åˆè§„çš„åŸå­èƒ½åŠ›ï¼Œè¿™åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­è‡³å…³é‡è¦ã€‚

2. åŸºäºç»Ÿè®¡çš„â€œæ•°æ®è´¨é‡ï¼ˆDQï¼‰è§„åˆ™â€è‡ªåŠ¨å»ºè®®ï¼š

ç°çŠ¶ï¼š æ­¥éª¤2ä¸­AIåˆ†æäº†â€œåŸºæ•°ã€ç©ºå€¼ç‡â€ã€‚

ä¼˜åŒ–ï¼š æ­¥éª¤3ä¸­ï¼ŒAIåŸºäºè¿™äº›ç»Ÿè®¡æ•°æ®ï¼Œä¸»åŠ¨å»ºè®®æ•°æ®è´¨é‡è§„åˆ™ã€‚

ç¤ºä¾‹1ï¼š AIå‘ç°order_statusåˆ—çš„é‡‡æ ·æ•°æ®ä¸­åªæœ‰'paid', 'shipped', 'pending'ä¸‰ç§å€¼ã€‚AIåº”è‡ªåŠ¨åœ¨å…ƒæ•°æ®ä¸­å»ºè®®ä¸€æ¡DQè§„åˆ™ï¼šâ€œorder_status åº”ä¸ºæšä¸¾å€¼ ('paid', 'shipped', 'pending')â€ã€‚

ç¤ºä¾‹2ï¼š AIå‘ç°ageåˆ—çš„é‡‡æ ·æ•°æ®ä¸­å‡ºç°äº†-5ã€‚AIåº”å»ºè®®DQè§„åˆ™ï¼šâ€œage åˆ—åº” > 0â€ã€‚

ä»·å€¼ï¼š è¿™æ˜¯â€œAI+æ•°æ®æ²»ç†â€çš„æ ¸å¿ƒä½“ç°ã€‚æ‚¨çš„å·¥å…·ä¸å†åªæ˜¯ä¸€ä¸ªâ€œæ•°æ®åœ°å›¾â€ï¼Œè€Œæ˜¯ä¸€ä¸ªèƒ½ä¸»åŠ¨æå‡æ•°æ®è´¨é‡çš„â€œæ™ºèƒ½æ²»ç†å¹³å°â€ã€‚

å»ºè®®ä¸‰ï¼šã€æµç¨‹é—­ç¯ã€‘å»ºç«‹â€œæ•°æ®ç”Ÿå‘½å‘¨æœŸä¸å˜æ›´ç®¡ç†â€æœºåˆ¶
è¿™æ˜¯ä¸ºäº†è§£å†³ä¸€ä¸ªâ€œæˆ¿é—´é‡Œçš„å¤§è±¡â€é—®é¢˜ï¼šæ•°æ®æºæ˜¯ä¼šå˜çš„ã€‚æ‚¨å½“å‰çš„æµç¨‹æ˜¯ä¸€æ¬¡æ€§çš„â€œæ¥å…¥â€ï¼Œå¦‚æœæ•°æ®æºå‘ç”Ÿå˜åŒ–ï¼Œæ‚¨çš„çŸ¥è¯†åº“å°±ä¼šâ€œè¿‡æ—¶â€ã€‚

ç°çŠ¶ï¼š æ¥å…¥ -> åˆ†æ -> å®Œæˆã€‚çŸ¥è¯†åº“æ˜¯é™æ€çš„ã€‚

é—®é¢˜ï¼š ä¸‹å‘¨ï¼Œä¸šåŠ¡æ–¹åœ¨ordersè¡¨ä¸­å¢åŠ äº†ä¸€ä¸ªæ–°å­—æ®µdiscount_codeã€‚æ‚¨çš„å¹³å°å°†å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚AIæ— æ³•å›ç­”å…³äºæ–°å­—æ®µçš„ä»»ä½•é—®é¢˜ï¼Œå¯¼è‡´çŸ¥è¯†åº“â€œå¤±çœŸâ€ã€‚

ä¼˜åŒ–ï¼š

Schemaå˜æ›´æ£€æµ‹ï¼ˆDrift Detectionï¼‰ï¼š æ‚¨çš„å·¥å…·éœ€è¦ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œå®šæœŸï¼ˆå¦‚æ¯å¤©ä¸€æ¬¡ï¼‰é‡æ–°æ‰§è¡Œæ­¥éª¤2ï¼ˆæ•°æ®é‡‡é›†ä¸åˆ†æï¼‰çš„è½»é‡çº§ç‰ˆæœ¬ï¼Œåªæ‹‰å–è¡¨ç»“æ„ã€‚

ç‰ˆæœ¬åŒ–å…ƒæ•°æ®ï¼š å¯¹æ¯”æ–°æ—§Schemaã€‚å½“æ£€æµ‹åˆ°â€œDriftâ€ï¼ˆå˜æ›´ï¼‰æ—¶ï¼Œæ‚¨çš„â€œæŒä¹…åŒ–JSONâ€ï¼ˆæˆ–KGï¼‰åº”æ”¯æŒç‰ˆæœ¬æ§åˆ¶ã€‚

è‡ªåŠ¨è§¦å‘å†å¤„ç†ï¼š ä¸€æ—¦æ£€æµ‹åˆ°å˜æ›´ï¼Œç³»ç»Ÿåº”è‡ªåŠ¨å¯¹â€œå·²å˜æ›´â€çš„è¡¨è§¦å‘æ­¥éª¤ 3 -> 7 çš„å®Œæ•´æµç¨‹ï¼ˆAIä¸°å¯Œã€ç”Ÿæˆæ–°MDæŠ¥å‘Šã€é‡æ–°å‘é‡åŒ–ï¼‰ã€‚

ä»·å€¼ï¼š ç¡®ä¿æ‚¨çš„AIçŸ¥è¯†åº“å§‹ç»ˆä¸ç‰©ç†æ•°æ®æºä¿æŒåŒæ­¥ã€‚è¿™æ˜¯å†³å®šä¸€ä¸ªæ•°æ®æ²»ç†å¹³å°æ˜¯å¦â€œå¯é â€å’Œâ€œå¯ç»´æŠ¤â€çš„å…³é”®å› ç´ ã€‚


### **2.1. æ•´ä½“æ¶æ„å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API å±‚ (Web Layer)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Chat API      â”‚  â”‚   RAG API       â”‚  â”‚  Document API   â”‚  â”‚
â”‚  â”‚   (åŒæ­¥/æµå¼)    â”‚  â”‚   (åŒæ­¥/æµå¼)    â”‚  â”‚   (ç®¡ç†/æŸ¥è¯¢)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Metadata API    â”‚  â”‚ Database API    â”‚  â”‚  Analysis API   â”‚  â”‚
â”‚  â”‚  (å…ƒæ•°æ®æŸ¥è¯¢)    â”‚  â”‚  (è¿æ¥ç®¡ç†)      â”‚  â”‚   (æ™ºèƒ½åˆ†æ)     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æœåŠ¡å±‚ (Service Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Conversation    â”‚  â”‚   RAG Service   â”‚  â”‚ Document Mgmt   â”‚  â”‚
â”‚  â”‚   Service       â”‚  â”‚                 â”‚  â”‚   Service       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Ingestion      â”‚  â”‚ MetadataCollectorâ”‚  â”‚ DocumentConverterâ”‚  â”‚
â”‚  â”‚   Service       â”‚  â”‚   Service       â”‚  â”‚   Service       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ•°æ®åº“æ–¹è¨€å±‚ (Dialect Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   MySQL         â”‚  â”‚  PostgreSQL     â”‚  â”‚  SQL Server     â”‚  â”‚
â”‚  â”‚   Dialect       â”‚  â”‚   Dialect       â”‚  â”‚   Dialect       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      æ•°æ®å±‚ (Data Layer)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚    pgvector     â”‚  â”‚  Target DBs     â”‚  â”‚
â”‚  â”‚   (ä¸»æ•°æ®åº“)     â”‚  â”‚   (å‘é‡å­˜å‚¨)     â”‚  â”‚ (è¢«åˆ†ææ•°æ®åº“)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2.2. æ ¸å¿ƒæ¨¡å—è¯´æ˜**

#### **2.2.1. æ•°æ®åº“åˆ†ææ¨¡å—**
- **MetadataCollectorService**: æ•°æ®åº“å…ƒæ•°æ®é‡‡é›†æ ¸å¿ƒæœåŠ¡ï¼Œæ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹
- **DatabaseDialect**: æ•°æ®åº“æ–¹è¨€æ¥å£ï¼Œå°è£…ä¸åŒæ•°æ®åº“çš„ç‰¹å®šæ“ä½œ
  - MySqlDialect: MySQLæ•°æ®åº“æ–¹è¨€å®ç°
  - PostgreSqlDialect: PostgreSQLæ•°æ®åº“æ–¹è¨€å®ç°  
  - SqlServerDialect: SQL Serveræ•°æ®åº“æ–¹è¨€å®ç°
- **DocumentConverterService**: å…ƒæ•°æ®åˆ°ç»“æ„åŒ–æ–‡æ¡£çš„è½¬æ¢æœåŠ¡

#### **2.2.2. AIæ¨¡å—**
- **ConversationService**: å¯¹è¯ç®¡ç†æœåŠ¡ï¼Œæ”¯æŒRAGå’Œçº¯èŠå¤©ä¸¤ç§æ¨¡å¼
- **RAGService**: RAGæ ¸å¿ƒæœåŠ¡ (å·²æ ‡è®°ä¸ºDeprecatedï¼ŒåŠŸèƒ½å·²è¿ç§»åˆ°ConversationService)
- **DocumentManagementService**: æ–‡æ¡£ç®¡ç†æœåŠ¡ï¼Œè´Ÿè´£æ–‡æ¡£çš„CRUDæ“ä½œ
- **IngestionService**: æ–‡æ¡£æ‘„å–æœåŠ¡ï¼Œè´Ÿè´£æ–‡æ¡£çš„è§£æã€åˆ†å—å’Œå‘é‡åŒ–

#### **2.2.3. æ•°æ®æ¨¡å‹**
- **DatabaseMetadata**: æ•°æ®åº“å…ƒæ•°æ®æ ¹å¯¹è±¡
- **CatalogMetadata**: æ•°æ®åº“ç›®å½•å…ƒæ•°æ®
- **TableMetadata**: è¡¨å…ƒæ•°æ®ï¼ŒåŒ…å«è¡¨ç»“æ„å’Œç»Ÿè®¡ä¿¡æ¯
- **ColumnMetadata**: åˆ—å…ƒæ•°æ®ï¼ŒåŒ…å«åˆ—å®šä¹‰å’Œæ•°æ®è´¨é‡æŒ‡æ ‡

### **2.3. åŒ…ç»“æ„å®šä¹‰**

```
com.zwbd.dbcrawlerv4
â”œâ”€â”€ ai/                          # AI æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ config/                  # AI ç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ service/                 # AI æ ¸å¿ƒæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ ConversationService  # å¯¹è¯ç®¡ç†æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ RAGService          # RAG æœåŠ¡ (Deprecated)
â”‚   â”‚   â”œâ”€â”€ DocumentManagementService # æ–‡æ¡£ç®¡ç†æœåŠ¡
â”‚   â”‚   â””â”€â”€ IngestionService    # æ–‡æ¡£æ‘„å–æœåŠ¡
â”‚   â”œâ”€â”€ web/                    # Web å±‚
â”‚   â”‚   â”œâ”€â”€ controller/         # REST æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ dto/               # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â””â”€â”€ repository/            # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ service/                   # æ•°æ®åº“åˆ†ææœåŠ¡
â”‚   â”œâ”€â”€ MetadataCollectorService # å…ƒæ•°æ®é‡‡é›†æœåŠ¡
â”‚   â””â”€â”€ DocumentConverterService # æ–‡æ¡£è½¬æ¢æœåŠ¡ (å¾…å®ç°)
â”œâ”€â”€ dialect/                   # æ•°æ®åº“æ–¹è¨€
â”‚   â”œâ”€â”€ DatabaseDialect        # æ–¹è¨€æ¥å£
â”‚   â”œâ”€â”€ MySqlDialect          # MySQLæ–¹è¨€å®ç°
â”‚   â”œâ”€â”€ PostgreSqlDialect     # PostgreSQLæ–¹è¨€å®ç°
â”‚   â””â”€â”€ SqlServerDialect      # SQL Serveræ–¹è¨€å®ç°
â”œâ”€â”€ model/                     # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ DatabaseMetadata      # æ•°æ®åº“å…ƒæ•°æ®
â”‚   â”œâ”€â”€ CatalogMetadata       # ç›®å½•å…ƒæ•°æ®
â”‚   â”œâ”€â”€ TableMetadata         # è¡¨å…ƒæ•°æ®
â”‚   â””â”€â”€ ColumnMetadata        # åˆ—å…ƒæ•°æ®
â”œâ”€â”€ config/                    # å…¨å±€é…ç½®
â”œâ”€â”€ common/                    # é€šç”¨å·¥å…·å’Œå¼‚å¸¸
â””â”€â”€ DbCrawlerV4Application    # ä¸»å¯åŠ¨ç±»
```

### **2.4. æ ¸å¿ƒåŠŸèƒ½å®ç°**

#### **2.4.1. æ•°æ®åº“å…ƒæ•°æ®é‡‡é›†**

**MetadataCollectorService** æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£ä»å„ç§æ•°æ®åº“ä¸­é‡‡é›†å®Œæ•´çš„å…ƒæ•°æ®ä¿¡æ¯ï¼š

```java
@Service
public class MetadataCollectorService {
    // æ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹çš„å…ƒæ•°æ®é‡‡é›†
    public DatabaseMetadata collectDatabaseMetadata(String url, String username, String password, String databaseType)
    
    // å¼‚æ­¥é‡‡é›†ï¼Œæ”¯æŒå¤§å‹æ•°æ®åº“
    public CompletableFuture<DatabaseMetadata> collectDatabaseMetadataAsync(...)
    
    // å¢é‡é‡‡é›†ï¼Œåªè·å–å˜æ›´çš„å…ƒæ•°æ®
    public DatabaseMetadata collectIncrementalMetadata(...)
}
```

**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§ï¼š**
- æ”¯æŒMySQLã€PostgreSQLã€SQL Serverç­‰ä¸»æµæ•°æ®åº“
- é‡‡é›†è¡¨ç»“æ„ã€åˆ—ä¿¡æ¯ã€ç´¢å¼•ã€çº¦æŸã€ç»Ÿè®¡ä¿¡æ¯ç­‰å®Œæ•´å…ƒæ•°æ®
- æ”¯æŒå¼‚æ­¥é‡‡é›†ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
- æä¾›è¶…æ—¶æ§åˆ¶å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- æ”¯æŒå¢é‡é‡‡é›†ï¼Œæå‡å¤§å‹æ•°æ®åº“çš„é‡‡é›†æ•ˆç‡

#### **2.4.2. AIé—®ç­”æœåŠ¡**

**ConversationService** æä¾›æ™ºèƒ½é—®ç­”èƒ½åŠ›ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š

```java
@Service
public class ConversationService {
    // RAGæ¨¡å¼ï¼šåŸºäºçŸ¥è¯†åº“çš„é—®ç­”
    public String ask(String query, boolean useRag, RAGFilters filters, String sessionId)
    
    // æµå¼å“åº”ï¼šå®æ—¶è¿”å›ç”Ÿæˆå†…å®¹
    public Flux<String> stream(String query, boolean useRag, RAGFilters filters, String sessionId)
    
    // æ–‡æ¡£æ£€ç´¢ï¼šä»å‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£
    private List<Document> retrieveDocuments(String query, RAGFilters filters)
}
```

**æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§ï¼š**
- æ”¯æŒRAGå¢å¼ºå’Œçº¯èŠå¤©ä¸¤ç§æ¨¡å¼
- æµå¼å“åº”ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- ä¼šè¯å†å²ç®¡ç†ï¼Œæ”¯æŒå¤šè½®å¯¹è¯
- æ–‡æ¡£è¿‡æ»¤å’Œç›¸å…³æ€§æ’åº
- é›†æˆSpring AIï¼Œæ”¯æŒå¤šç§LLMæ¨¡å‹

#### **2.4.3. æ–‡æ¡£ç®¡ç†ä¸æ‘„å–**

**IngestionService** è´Ÿè´£æ–‡æ¡£çš„å¤„ç†å’Œå‘é‡åŒ–ï¼š

```java
@Service
public class IngestionService {
    // æ–‡æ¡£æ‘„å–ï¼šè§£æã€åˆ†å—ã€å‘é‡åŒ–
    public void ingest(String filePath, Map<String, Object> metadata)
    
    // æ‰¹é‡æ‘„å–ï¼šå¤„ç†å¤šä¸ªæ–‡æ¡£
    public void batchIngest(List<String> filePaths)
    
    // æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼
    private Document loadDocument(String filePath)
}
```

**DocumentManagementService** æä¾›æ–‡æ¡£çš„CRUDæ“ä½œï¼š

```java
@Service
public class DocumentManagementService {
    // æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£æ‘˜è¦
    public List<DocumentSummary> listAllDocuments()
    
    // è·å–æ–‡æ¡£åˆ†ç‰‡
    public List<DocumentChunk> getDocumentChunks(String documentId)
    
    // åˆ é™¤æ–‡æ¡£åŠå…¶å‘é‡
    public void deleteDocument(String documentId)
}
```

## **3\. APIè®¾è®¡**

### **3.1. æ ¸å¿ƒAPIæ¥å£**

#### **3.1.1. AIé—®ç­”API**

```http
POST /api/ai/chat
Content-Type: application/json

{
    "query": "ç”¨æˆ·é—®é¢˜",
    "useRag": true,
    "ragFilters": {
        "documentIds": ["doc1", "doc2"],
        "tags": ["database", "metadata"]
    },
    "sessionId": "session-123"
}
```

**æµå¼å“åº”APIï¼š**
```http
POST /api/ai/chat-stream
Content-Type: application/json
Accept: text/event-stream

{
    "query": "ç”¨æˆ·é—®é¢˜",
    "useRag": true,
    "sessionId": "session-123"
}
```

#### **3.1.2. æ•°æ®åº“å…ƒæ•°æ®API**

```http
POST /api/metadata/collect
Content-Type: application/json

{
    "url": "jdbc:mysql://localhost:3306/testdb",
    "username": "user",
    "password": "password",
    "databaseType": "mysql",
    "async": true
}
```

#### **3.1.3. æ–‡æ¡£ç®¡ç†API**

```http
GET /api/documents
POST /api/documents/ingest
DELETE /api/documents/{documentId}
GET /api/documents/{documentId}/chunks
```

### **3.2. æ•°æ®æ¨¡å‹**

#### **3.2.1. æ•°æ®åº“å…ƒæ•°æ®æ¨¡å‹**

```java
public class DatabaseMetadata {
    private String databaseName;
    private String databaseType;
    private List<CatalogMetadata> catalogs;
    private Map<String, Object> properties;
    private LocalDateTime collectedAt;
}

public class TableMetadata {
    private String tableName;
    private String tableType;
    private List<ColumnMetadata> columns;
    private List<IndexMetadata> indexes;
    private TableStatistics statistics;
}

public class ColumnMetadata {
    private String columnName;
    private String dataType;
    private boolean nullable;
    private String defaultValue;
    private DataQualityMetrics qualityMetrics;
}
```

#### **3.2.2. å‘é‡å­˜å‚¨æ¨¡å‹**

```sql
-- æ–‡æ¡£å‘é‡å­˜å‚¨
CREATE TABLE vector_store (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,
    metadata JSONB,
    embedding vector(1536),  -- OpenAI embedding ç»´åº¦
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ä¼šè¯å†å²å­˜å‚¨
CREATE TABLE chat_messages (
    id BIGSERIAL PRIMARY KEY,
    session_id VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB
);
```

## **4\. æ•°æ®åº“è®¾è®¡ (Data Model)**

### **4.1. çŸ¥è¯†åº“åˆ†ç‰‡è¡¨ (document\_chunks)**

é‡‡ç”¨å•è¡¨å­˜å‚¨æ‰€æœ‰çŸ¥è¯†åˆ†ç‰‡ï¼Œåˆ©ç”¨ JSONB å­—æ®µçš„çµæ´»æ€§å­˜å‚¨æ‰€æœ‰å…ƒæ•°æ®ã€‚

* **DDL è„šæœ¬:**  
  CREATE EXTENSION IF NOT EXISTS vector;

  CREATE TABLE IF NOT EXISTS document\_chunks (  
  \-- ä¸»é”®ï¼ŒåŒ¹é… Spring AI PgVectorStore çš„é»˜è®¤çº¦å®š  
  id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
  content TEXT,  
  \-- å‘é‡ç»´åº¦(768)éœ€æ ¹æ®å®é™…ä½¿ç”¨çš„Embeddingæ¨¡å‹ä¿®æ”¹  
  embedding VECTOR(768) NOT NULL,  
  \-- å­˜å‚¨æ‰€æœ‰å…ƒæ•°æ®, åŒ…æ‹¬ document\_id, original\_filename ç­‰  
  metadata JSONB,  
  created\_at TIMESTAMPTZ DEFAULT NOW()  
  );

  \-- ä¸ºå…ƒæ•°æ®å’Œå‘é‡åˆ›å»ºç´¢å¼•ä»¥ä¼˜åŒ–æŸ¥è¯¢  
  CREATE INDEX IF NOT EXISTS idx\_metadata ON document\_chunks USING gin (metadata);  
  CREATE INDEX IF NOT EXISTS idx\_embedding\_hnsw ON document\_chunks USING hnsw (embedding vector\_cosine\_ops);

### **4.2. ä¼šè¯å†å²è¡¨ (conversation\_history)**

ç”¨äºæŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰å¤šè½®å¯¹è¯çš„æ¶ˆæ¯ã€‚

* **DDL è„šæœ¬:**  
  CREATE TABLE IF NOT EXISTS conversation\_history (  
  message\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
  session\_id VARCHAR(255) NOT NULL,  
  \-- æ¶ˆæ¯åœ¨ä¼šè¯ä¸­çš„é¡ºåº  
  message\_order INT NOT NULL,  
  \-- è§’è‰²: 'user' æˆ– 'assistant'  
  role VARCHAR(50) NOT NULL,  
  content TEXT,  
  created\_at TIMESTAMPTZ DEFAULT NOW()  
  );

  \-- ä¸ºä¼šè¯æŸ¥è¯¢å’Œæ’åºåˆ›å»ºç´¢å¼•  
  CREATE INDEX IF NOT EXISTS idx\_session\_id ON conversation\_history (session\_id);  
  CREATE INDEX IF NOT EXISTS idx\_session\_id\_order ON conversation\_history (session\_id, message\_order);

## **5\. åç»­å¼€å‘æ–¹å‘ä¸æŠ€æœ¯è·¯çº¿å›¾**

### **5.1. æ ¸å¿ƒå¾…å®ç°åŠŸèƒ½**

#### **5.1.1. DocumentConverterService (é«˜ä¼˜å…ˆçº§)**

å°†MetadataCollectorServiceé‡‡é›†çš„DatabaseMetadataè½¬æ¢ä¸ºç»“æ„åŒ–æ–‡æ¡£ï¼Œä¸ºRAGçŸ¥è¯†åº“æä¾›æ•°æ®æºï¼š

```java
@Service
public class DocumentConverterService {
    
    /**
     * Convert DatabaseMetadata to structured documents
     * @param metadata Database metadata collected by MetadataCollectorService
     * @return List of structured documents ready for RAG ingestion
     */
    public List<StructuredDocument> convertToDocuments(DatabaseMetadata metadata) {
        // 1. ç”Ÿæˆæ•°æ®åº“æ¦‚è§ˆæ–‡æ¡£
        // 2. ä¸ºæ¯ä¸ªè¡¨ç”Ÿæˆè¯¦ç»†æ–‡æ¡£
        // 3. ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Šæ–‡æ¡£
        // 4. ç”Ÿæˆæ•°æ®å­—å…¸æ–‡æ¡£
    }
    
    /**
     * Generate markdown documentation from metadata
     */
    public String generateMarkdownDocumentation(DatabaseMetadata metadata) {
        // ç”Ÿæˆäººç±»å¯è¯»çš„Markdownæ ¼å¼æ–‡æ¡£
    }
    
    /**
     * Generate JSON schema documentation
     */
    public String generateJsonSchema(TableMetadata table) {
        // ç”ŸæˆJSON Schemaæ ¼å¼çš„è¡¨ç»“æ„æ–‡æ¡£
    }
}
```

**å®ç°è¦ç‚¹ï¼š**
- æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼šMarkdownã€JSONã€XMLã€HTML
- ç”Ÿæˆç»“æ„åŒ–çš„æ•°æ®å­—å…¸å’Œæ•°æ®è´¨é‡æŠ¥å‘Š
- æ”¯æŒæ¨¡æ¿åŒ–æ–‡æ¡£ç”Ÿæˆï¼Œä¾¿äºå®šåˆ¶åŒ–
- é›†æˆæ•°æ®è¡€ç¼˜åˆ†æå’Œå½±å“åˆ†æ

#### **5.1.2. æ™ºèƒ½æ•°æ®åˆ†æAPI (ä¸­ä¼˜å…ˆçº§)**

åŸºäºé‡‡é›†çš„å…ƒæ•°æ®æä¾›æ™ºèƒ½åˆ†æèƒ½åŠ›ï¼š

```java
@RestController
@RequestMapping("/api/analysis")
public class DataAnalysisController {
    
    @PostMapping("/quality-report")
    public DataQualityReport generateQualityReport(@RequestBody DatabaseMetadata metadata);
    
    @PostMapping("/schema-comparison")
    public SchemaComparisonResult compareSchemas(@RequestBody SchemaComparisonRequest request);
    
    @PostMapping("/optimization-suggestions")
    public List<OptimizationSuggestion> getOptimizationSuggestions(@RequestBody DatabaseMetadata metadata);
}
```

#### **5.1.3. å…ƒæ•°æ®ç®¡ç†API (ä¸­ä¼˜å…ˆçº§)**

æä¾›æ•°æ®åº“è¿æ¥ç®¡ç†å’Œå…ƒæ•°æ®æŸ¥è¯¢APIï¼š

```java
@RestController
@RequestMapping("/api/metadata")
public class MetadataController {
    
    @PostMapping("/collect")
    public ResponseEntity<DatabaseMetadata> collectMetadata(@RequestBody DatabaseConnectionRequest request);
    
    @GetMapping("/databases")
    public List<DatabaseSummary> listDatabases();
    
    @GetMapping("/databases/{id}/tables")
    public List<TableSummary> listTables(@PathVariable String id);
    
    @GetMapping("/tables/{id}/columns")
    public List<ColumnMetadata> getTableColumns(@PathVariable String id);
}
```

### **5.2. æŠ€æœ¯å¢å¼ºæ–¹å‘**

#### **5.2.1. æ•°æ®åº“æ”¯æŒæ‰©å±•**
- **Oracleæ•°æ®åº“æ”¯æŒ**: å®ç°OracleDialect
- **MongoDBæ”¯æŒ**: å®ç°NoSQLæ•°æ®åº“çš„å…ƒæ•°æ®é‡‡é›†
- **Elasticsearchæ”¯æŒ**: æ”¯æŒæœç´¢å¼•æ“çš„ç´¢å¼•ç»“æ„åˆ†æ
- **äº‘æ•°æ®åº“æ”¯æŒ**: AWS RDSã€Azure SQLã€Google Cloud SQLç­‰

#### **5.2.2. AIèƒ½åŠ›å¢å¼º**
- **å¤šæ¨¡æ€æ”¯æŒ**: æ”¯æŒå›¾è¡¨ã€å›¾åƒç­‰å¤šåª’ä½“å†…å®¹çš„ç†è§£
- **ä»£ç ç”Ÿæˆ**: åŸºäºæ•°æ®åº“ç»“æ„è‡ªåŠ¨ç”ŸæˆSQLã€DDLã€å®ä½“ç±»ç­‰
- **æ™ºèƒ½æ¨è**: åŸºäºå†å²æŸ¥è¯¢å’Œå…ƒæ•°æ®æä¾›æ™ºèƒ½å»ºè®®
- **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**: å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºSQLæŸ¥è¯¢

#### **5.2.3. æ€§èƒ½ä¼˜åŒ–**
- **å¢é‡é‡‡é›†**: åªé‡‡é›†å˜æ›´çš„å…ƒæ•°æ®ï¼Œæå‡å¤§å‹æ•°æ®åº“çš„å¤„ç†æ•ˆç‡
- **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šæ•°æ®åº“å¹¶è¡Œé‡‡é›†
- **ç¼“å­˜æœºåˆ¶**: å®ç°å…ƒæ•°æ®ç¼“å­˜ï¼Œå‡å°‘é‡å¤é‡‡é›†
- **æµå¼å¤„ç†**: æ”¯æŒå¤§å‹æ•°æ®åº“çš„æµå¼å…ƒæ•°æ®å¤„ç†

### **5.3. ç³»ç»Ÿé›†æˆæ–¹å‘**

#### **5.3.1. æ•°æ®æ²»ç†å¹³å°é›†æˆ**
- **æ•°æ®è¡€ç¼˜è¿½è¸ª**: åˆ†æè¡¨é—´å…³ç³»å’Œæ•°æ®æµå‘
- **æ•°æ®è´¨é‡ç›‘æ§**: å®æ—¶ç›‘æ§æ•°æ®è´¨é‡æŒ‡æ ‡
- **åˆè§„æ€§æ£€æŸ¥**: è‡ªåŠ¨æ£€æŸ¥æ•°æ®åˆè§„æ€§å’Œå®‰å…¨æ€§
- **å…ƒæ•°æ®æ ‡å‡†åŒ–**: å»ºç«‹ä¼ä¸šçº§å…ƒæ•°æ®æ ‡å‡†

#### **5.3.2. DevOpsé›†æˆ**
- **CI/CDé›†æˆ**: é›†æˆåˆ°æŒç»­é›†æˆæµæ°´çº¿
- **ç›‘æ§å‘Šè­¦**: æ•°æ®åº“ç»“æ„å˜æ›´ç›‘æ§å’Œå‘Šè­¦
- **è‡ªåŠ¨åŒ–æµ‹è¯•**: åŸºäºå…ƒæ•°æ®çš„è‡ªåŠ¨åŒ–æµ‹è¯•ç”Ÿæˆ
- **æ–‡æ¡£è‡ªåŠ¨åŒ–**: è‡ªåŠ¨ç”Ÿæˆå’Œæ›´æ–°æŠ€æœ¯æ–‡æ¡£

### **5.4. å¼€å‘ä¼˜å…ˆçº§è§„åˆ’**

#### **Phase 1 (å½“å‰é˜¶æ®µ - 1-2å‘¨)**
1. âœ… å®Œæˆç³»ç»Ÿæ¶æ„åˆ†æå’Œæ–‡æ¡£æ›´æ–°
2. ğŸ”„ å®ç°DocumentConverterServiceæ ¸å¿ƒåŠŸèƒ½
3. ğŸ”„ é›†æˆå…ƒæ•°æ®è½¬æ¢åˆ°RAGçŸ¥è¯†åº“çš„å®Œæ•´æµç¨‹
4. ğŸ”„ å®Œå–„APIæ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

#### **Phase 2 (çŸ­æœŸç›®æ ‡ - 2-4å‘¨)**
1. å®ç°MetadataController API
2. æ·»åŠ Oracleå’ŒMongoDBæ”¯æŒ
3. å®ç°æ•°æ®è´¨é‡åˆ†æåŠŸèƒ½
4. ä¼˜åŒ–æ€§èƒ½å’Œé”™è¯¯å¤„ç†

#### **Phase 3 (ä¸­æœŸç›®æ ‡ - 1-2ä¸ªæœˆ)**
1. å®ç°æ™ºèƒ½æ•°æ®åˆ†æåŠŸèƒ½
2. æ·»åŠ ä»£ç ç”Ÿæˆèƒ½åŠ›
3. å®ç°æ•°æ®è¡€ç¼˜åˆ†æ
4. å®Œå–„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

#### **Phase 4 (é•¿æœŸç›®æ ‡ - 3-6ä¸ªæœˆ)**
1. æ„å»ºå®Œæ•´çš„æ•°æ®æ²»ç†å¹³å°
2. å®ç°å¤šæ¨¡æ€AIèƒ½åŠ›
3. äº‘åŸç”Ÿéƒ¨ç½²æ”¯æŒ
4. ä¼ä¸šçº§å®‰å…¨å’Œæƒé™ç®¡ç†

## **6\. API æ¥å£å¥‘çº¦ (API Contracts)**

### **6.1. AI é—®ç­”æ¥å£ (RAGController)**

* **POST /api/rag/chat-stream (æµå¼, æ¨è)**
  * **æè¿°:** æ‰§è¡Œä¸€æ¬¡å¯¹è¯ï¼Œé€šè¿‡ SSE è¿”å›ç»“æ„åŒ–çš„äº‹ä»¶æµã€‚æ”¯æŒRAGå¼€å…³å’Œå¤šè½®å¯¹è¯ã€‚
  * **è¯·æ±‚ä½“ (ChatRequest.java):**  
    {  
    "query": "è¯·é—®å…¬å¸çš„å¹´å‡æ”¿ç­–æ˜¯ä»€ä¹ˆï¼Ÿ",  
    "useRag": true,  
    "RAGFilters": \[  
    { "key": "document\_type", "operator": "EQUALS", "value": "Policy" }  
    \],  
    "sessionId": "session-12345"  
    }

  * **å“åº” (text/event-stream):**  
    data:{"eventType":"SESSION\_INFO","payload":{"sessionId":"new-session-xyz"}}  
    data:{"eventType":"CONTEXT","payload":\[{"chunkId":...}\]}  
    data:{"eventType":"TEXT","payload":"æ ¹æ®..."}  
    data:{"eventType":"TEXT","payload":"çŸ¥è¯†åº“..."}  
    data:{"eventType":"END","payload":null}

* **POST /api/rag/chat (é˜»å¡å¼)**
  * **æè¿°:** æ‰§è¡Œä¸€æ¬¡å¯¹è¯ï¼Œä¸€æ¬¡æ€§è¿”å›å®Œæ•´çš„æœ€ç»ˆç»“æœã€‚é€‚ç”¨äºåç«¯æœåŠ¡è°ƒç”¨æˆ–æµ‹è¯•ã€‚
  * **å“åº” (ChatResponse.java):**  
    {  
    "answer": "æ ¹æ®çŸ¥è¯†åº“ä¿¡æ¯...",  
    "retrievedDocuments": \[...\],  
    "sessionId": "session-12345"  
    }

### **4.2. æ•°æ®æ³¨å…¥æ¥å£ (UploadController)**

* **POST /api/upload**
  * **æè¿°:** ä¸Šä¼ æ–‡ä»¶ï¼ˆå¦‚.md, .pdfï¼‰å¹¶è‡ªåŠ¨æ³¨å…¥çŸ¥è¯†åº“ã€‚
  * **è¯·æ±‚ä½“ (multipart/form-data):**
    * file: æ–‡ä»¶æœ¬èº«
    * source\_system (å¯é€‰): å…ƒæ•°æ®
    * document\_type (å¯é€‰): å…ƒæ•°æ®

### **4.3. çŸ¥è¯†åº“ç®¡ç†æ¥å£ (DocumentManagementController)**

* **GET /api/documents**: åˆ—å‡ºæ‰€æœ‰å·²æ³¨å…¥çš„æ–‡æ¡£ã€‚
* **GET /api/documents/{documentId}**: æŸ¥çœ‹æŒ‡å®šæ–‡æ¡£çš„æ‰€æœ‰åˆ†ç‰‡å†…å®¹ã€‚
* **DELETE /api/documents/{documentId}**: åˆ é™¤æŒ‡å®šæ–‡æ¡£åŠå…¶æ‰€æœ‰åˆ†ç‰‡ã€‚
* **PUT /api/documents/chunks/{chunkId}**: ä¿®æ”¹æŒ‡å®šåˆ†ç‰‡çš„å†…å®¹ï¼Œå¹¶è‡ªåŠ¨é‡æ–°å‘é‡åŒ–ã€‚

### **4.4. ä¼šè¯ç®¡ç†æ¥å£ (ConversationController)**

* **GET /api/conversations**: åˆ—å‡ºæ‰€æœ‰å†å²ä¼šè¯çš„ IDã€‚
* **DELETE /api/conversations/{sessionId}**: åˆ é™¤æŒ‡å®šçš„ä¼šè¯å†å²ã€‚

## **5\. æœªæ¥å±•æœ›ä¸æ‰©å±•æ–¹å‘**

* **é«˜çº§æ£€ç´¢ç­–ç•¥:** é›†æˆæ··åˆæœç´¢ï¼ˆå‘é‡ \+ å…¨æ–‡ï¼‰ã€é‡æ’åºï¼ˆRe-rankingï¼‰ç­‰æŠ€æœ¯æå‡æ£€ç´¢ç²¾åº¦ã€‚
* **Agent ä¸å·¥å…·è°ƒç”¨:** æ‰©å±•æ¡†æ¶ä»¥æ”¯æŒ Agent æ¨¡å¼ï¼Œä½¿å…¶èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æ„å›¾è°ƒç”¨å¤–éƒ¨å·¥å…·ï¼ˆå¦‚APIã€æ•°æ®åº“æŸ¥è¯¢ï¼‰ã€‚
* **å¯è§‚æµ‹æ€§:** æ·±å…¥é›†æˆé¥æµ‹ï¼ˆTracing, Metrics, Loggingï¼‰ï¼Œç›‘æ§ Token æ¶ˆè€—ã€æ£€ç´¢å»¶è¿Ÿã€å›ç­”è´¨é‡ç­‰å…³é”®æŒ‡æ ‡ã€‚
* **å¤šæ¨¡æ€æ”¯æŒ:** æ‰©å±•æ•°æ®åŠ è½½å™¨å’Œæ¨¡å‹å®¢æˆ·ç«¯ï¼Œä»¥æ”¯æŒå¯¹å›¾ç‰‡ç­‰å¤šæ¨¡æ€æ•°æ®çš„å¤„ç†å’Œç†è§£ã€‚
* **çŸ¥è¯†åº“ç®¡ç†ç•Œé¢:** å¼€å‘ä¸€ä¸ªç®€å•çš„ UI ç•Œé¢ï¼Œå®ç°å¯¹çŸ¥è¯†åº“å’Œä¼šè¯çš„å¯è§†åŒ–ç®¡ç†ã€‚